<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建德市实时天气</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
        body {background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: #fff; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center;}
        .weather-container {background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); border-radius: 20px; width: 90%; max-width: 800px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);}
        .header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2);}
        .location h1 {font-size: 2.2rem; font-weight: 600;}
        .location p {font-size: 1rem; opacity: 0.8;}
        .current-time {font-size: 1.1rem; opacity: 0.9;}
        .weather-main {display: flex; align-items: center; margin-bottom: 30px;}
        .weather-icon {width: 40%; text-align: center;}
        .weather-icon img {width: 180px; height: 180px;}
        .weather-icon p {font-size: 1.8rem; margin-top: 10px; font-weight: 500;}
        .temperature {width: 60%; text-align: center; padding: 20px;}
        .current-temp {font-size: 5rem; font-weight: 300; line-height: 1;}
        .current-temp span {font-size: 2.5rem; vertical-align: super;}
        .feels-like {font-size: 1.2rem; margin: 15px 0; opacity: 0.9;}
        .weather-details {display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px;}
        .detail-card {background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s ease;}
        .detail-card:hover {transform: translateY(-5px); background: rgba(255, 255, 255, 0.15);}
        .detail-card i {font-size: 2rem; margin-bottom: 15px; color: #fdbb2d;}
        .detail-card h3 {font-size: 1rem; font-weight: 400; margin-bottom: 10px; opacity: 0.8;}
        .detail-card p {font-size: 1.4rem; font-weight: 500;}
        .wind-direction {display: flex; flex-direction: column; align-items: center;}
        .wind-arrow {width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); display: flex; justify-content: center; align-items: center; margin-bottom: 10px;}
        .wind-arrow i {font-size: 30px;}
        .update-info {text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); font-size: 0.9rem; opacity: 0.7;}
        .refresh-btn {background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .refresh-btn:hover {background: rgba(255, 255, 255, 0.2); transform: scale(1.05);}
        .status-message {text-align: center; padding: 20px; font-size: 1.2rem; color: #ffcc00;}
        @media (max-width: 768px) {
            .weather-main {flex-direction: column;}
            .weather-icon, .temperature {width: 100%;}
            .weather-details {grid-template-columns: 1fr;}
            .current-temp {font-size: 4rem;}
        }
        .loading {display: flex; justify-content: center; margin: 20px 0;}
        .spinner {width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite;}
        @keyframes spin {to {transform: rotate(360deg);}}
    </style>
</head>
<body>
    <div class="weather-container">
        <div class="header">
            <div class="location">
                <h1>建德市, 浙江省</h1>
                <p>中国</p>
            </div>
            <div class="current-time" id="current-time"></div>
        </div>
        
        <div id="weather-content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>
        </div>
        
        <button class="refresh-btn" id="refresh-btn">
            <i class="fas fa-sync-alt"></i> 刷新数据
        </button>
        
        <div class="status-message" id="status-message">
            正在加载天气数据...
        </div>
    </div>

    <script>
        // 定义基础URL
        const BASE_URL = 'https://cn.apihz.cn/api/tianqi/tqyb.php';
        const PARAMS = {
            id: '10007044',
            key: '2eb2d99834d81adaaed10aad06dc40aa',
            sheng: '浙江',
            place: '建德'
        };
        
        // 天气图标映射
        const WEATHER_ICONS = {
            '晴': 'https://cdn-icons-png.flaticon.com/512/6974/6974833.png',
            '多云': 'https://cdn-icons-png.flaticon.com/512/414/414927.png',
            '雨': 'https://cdn-icons-png.flaticon.com/512/3351/3351979.png',
            '雷阵雨': 'https://cdn-icons-png.flaticon.com/512/6974/6974833.png',
            '阴': 'https://cdn-icons-png.flaticon.com/512/414/414825.png',
            'default': 'https://cdn-icons-png.flaticon.com/512/414/414825.png'
        };
        
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-time').innerHTML = `
                <p>${now.toLocaleDateString('zh-CN', options)}</p>
            `;
        }
        
        // 构建API查询URL
        function buildApiUrl() {
            const params = new URLSearchParams(PARAMS);
            return `${BASE_URL}?${params.toString()}`;
        }
        
        // 获取天气数据
        async function fetchWeatherData() {
            try {
                setStatus('正在获取天气数据...', '#ffcc00');
                toggleLoading(true);
                
                // 尝试直接访问API
                let response;
                try {
                    // 尝试直接请求
                    response = await fetch(buildApiUrl(), {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                } catch (directError) {
                    console.log('直接请求失败，尝试代理:', directError);
                    // 使用CORS代理
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const url = proxyUrl + encodeURIComponent(buildApiUrl());
                    response = await fetch(url);
                }
                
                // 检查响应状态
                if (!response.ok) {
                    throw new Error(`网络错误: ${response.status} ${response.statusText}`);
                }
                
                // 解析JSON数据
                const data = await response.json();
                setStatus('数据加载成功', '#4CAF50');
                
                // 验证数据结构
                validateWeatherData(data);
                
                // 渲染天气信息
                renderWeather(data);
                toggleLoading(false);
                
            } catch (error) {
                console.error('天气数据获取失败:', error);
                setStatus(`错误: ${error.message}`, '#ff5252');
                toggleLoading(false);
            }
        }
        
        // 验证天气数据结构
        function validateWeatherData(data) {
            // 检查必需字段
            const requiredFields = ['temperature', 'feelst', 'humidity', 'windSpeed', 'windDirection', 'pressure'];
            const missingFields = requiredFields.filter(field => !(field in data));
            
            if (missingFields.length > 0) {
                throw new Error(`API返回数据缺少必要字段: ${missingFields.join(', ')}`);
            }
        }
        
        // 渲染天气界面
        function renderWeather(data) {
            // 准备视图模板
            const html = `
                <div class="weather-main">
                    <div class="weather-icon">
                        <img id="weather-icon" src="${getWeatherIcon(data.weather)}" alt="天气图标">
                        <p id="weather-condition">${data.weather || '--'}</p>
                    </div>
                    <div class="temperature">
                        <div class="current-temp" id="current-temp">${data.temp || '--'}<span>°C</span></div>
                        <div class="feels-like" id="feels-like">体感温度: ${data.temp || '--'}°C</div>
                    </div>
                </div>
                
                <div class="weather-details">
                    <div class="detail-card">
                        <i class="fas fa-tint"></i>
                        <h3>湿度</h3>
                        <p id="humidity">${data.humidity || '--'}%</p>
                    </div>
                    
                    <div class="detail-card">
                        <i class="fas fa-wind"></i>
                        <h3>风速</h3>
                        <p id="wind-speed">${data.wind_speed || '--'} m/s</p>
                        <p id="wind-level">${getWindLevel(parseFloat(data.wind_speed) || 0)}</p>
                    </div>
                    
                    <div class="detail-card">
                        <i class="fas fa-compress-alt"></i>
                        <h3>气压</h3>
                        <p id="pressure">${data.pressure || '--'} hPa</p>
                    </div>
                    
                    <div class="detail-card wind-direction">
                        <div class="wind-arrow">
                            <i class="fas fa-arrow-up" id="wind-arrow" 
                               style="transform: rotate(${data.wind_direction || 0}deg)"></i>
                        </div>
                        <h3>风向</h3>
                        <p id="wind-direction">${getWindDirection(parseInt(data.wind_direction) || 0)}</p>
                        <p id="wind-degree">${data.wind_direction || '--'}°</p>
                    </div>
                </div>
                
                <div class="update-info">
                    <p id="update-time">数据更新时间: ${new Date().toLocaleTimeString('zh-CN')}</p>
                </div>
            `;
            
            // 更新DOM
            document.getElementById('weather-content').innerHTML = html;
        }
        
        // 获取天气图标
        function getWeatherIcon(condition) {
            if (!condition) return WEATHER_ICONS.default;
            
            const conditionLower = condition.toLowerCase();
            for (const key in WEATHER_ICONS) {
                if (conditionLower.includes(key.toLowerCase())) {
                    return WEATHER_ICONS[key];
                }
            }
            
            return WEATHER_ICONS.default;
        }
        
        // 获取风力等级描述
        function getWindLevel(speed) {
            if (isNaN(speed) || speed < 0) return '未知';
            if (speed < 0.3) return '无风';
            if (speed < 1.6) return '软风';
            if (speed < 3.4) return '轻风';
            if (speed < 5.5) return '微风';
            if (speed < 8.0) return '和风';
            if (speed < 10.8) return '清风';
            if (speed < 13.9) return '强风';
            if (speed < 17.2) return '疾风';
            if (speed < 20.8) return '大风';
            if (speed < 24.5) return '烈风';
            if (speed < 28.5) return '狂风';
            if (speed < 32.7) return '暴风';
            return '飓风';
        }
        
        // 获取风向描述
        function getWindDirection(degree) {
            if (isNaN(degree)) return '未知';
            
            const directions = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
            const index = Math.round((degree % 360) / 45) % 8;
            return directions[index] + '风';
        }
        
        // 设置状态消息
        function setStatus(message, color = '#ffcc00') {
            const element = document.getElementById('status-message');
            element.textContent = message;
            element.style.color = color;
        }
        
        // 切换加载状态
        function toggleLoading(show) {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = show ? 'flex' : 'none';
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化时间显示
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 加载天气数据
            fetchWeatherData();
            
            // 添加刷新按钮事件
            document.getElementById('refresh-btn').addEventListener('click', fetchWeatherData);
        });
    </script>
</body>
</html>
